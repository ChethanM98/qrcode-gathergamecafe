<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Your Order</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4efe8;
  padding: 20px;
}

.container {
  max-width: 600px;
  margin: auto;
  background: #ffffff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

h1 {
  text-align: center;
}

.table-info {
  text-align: center;
  font-weight: bold;
  margin-bottom: 10px;
}

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 10px 0;
}

.item-name {
  flex: 1;
}

.qty {
  display: flex;
  align-items: center;
  gap: 8px;
}

.qty button {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: none;
  background: #7b4b2a;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
}

.price {
  min-width: 70px;
  text-align: right;
}

.total {
  font-size: 18px;
  font-weight: bold;
  text-align: right;
  margin-top: 15px;
}

button.place-btn {
  width: 100%;
  margin-top: 20px;
  padding: 14px;
  font-size: 16px;
  background: #3fa55b;
  color: white;
  border: none;
  border-radius: 999px;
  cursor: pointer;
}

button.place-btn:hover {
  background: #2f8c4c;
}

.back-link {
  display: block;
  text-align: center;
  margin-top: 15px;
  text-decoration: none;
  color: #7b4b2a;
  font-weight: bold;
}

.empty {
  text-align: center;
  color: #666;
}
</style>
</head>

<body>

<div class="container">
  <h1>Your Order</h1>
  <div id="tableInfo" class="table-info"></div>

  <div id="cartItems"></div>
  <div id="total" class="total"></div>

  <button class="place-btn" onclick="placeOrder()">Place Order</button>
  <a id="backLink" class="back-link">← Back to Menu</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const params = new URLSearchParams(window.location.search);
  const table = params.get("table") || "default";

  const CART_KEY = `cart_table_${table}`;
  const KITCHEN_KEY = "kitchen_orders";
  const QUEUE_KEY = "kitchen_queue";

  document.getElementById("tableInfo").innerText = `Table No: ${table}`;
  document.getElementById("backLink").href = `index.html?table=${table}`;

  let cart = JSON.parse(localStorage.getItem(CART_KEY)) || {};
  const cartItemsDiv = document.getElementById("cartItems");
  const totalDiv = document.getElementById("total");

  /* =========================
     RENDER CART
  ========================= */
  function renderCart() {
    cartItemsDiv.innerHTML = "";
    let total = 0;

    if (Object.keys(cart).length === 0) {
      cartItemsDiv.innerHTML =
        `<p class="empty">Your cart is empty</p>`;
      totalDiv.innerText = "";
      return;
    }

    for (const key in cart) {
      const item = cart[key];
      const itemTotal = item.price * item.qty;
      total += itemTotal;

      cartItemsDiv.innerHTML += `
        <div class="row" data-key="${key}">
          <div class="item-name">${item.name}</div>

          <div class="qty">
            <button class="minus">−</button>
            <span>${item.qty}</span>
            <button class="plus">+</button>
          </div>

          <div class="price">₹${itemTotal}</div>
        </div>
      `;
    }

    totalDiv.innerText = `Total: ₹${total}`;
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }

  /* =========================
     QUANTITY EVENTS
  ========================= */
  cartItemsDiv.addEventListener("click", e => {
    const row = e.target.closest(".row");
    if (!row) return;

    const key = row.dataset.key;

    if (e.target.classList.contains("plus")) {
      cart[key].qty++;
    }

    if (e.target.classList.contains("minus")) {
      cart[key].qty--;
      if (cart[key].qty === 0) delete cart[key];
    }

    renderCart();
  });

  /* =========================
     PLACE ORDER
  ========================= */
  window.placeOrder = function () {

    if (Object.keys(cart).length === 0) {
      alert("Cart is empty");
      return;
    }

    /* ---- 1️⃣ Kitchen Queue (NO APPEND) ---- */
    const queue = JSON.parse(localStorage.getItem(QUEUE_KEY)) || [];
    queue.push({
      table,
      items: JSON.parse(JSON.stringify(cart)),
      status: "Pending",
      time: new Date().toLocaleString()
    });
    localStorage.setItem(QUEUE_KEY, JSON.stringify(queue));

    /* ---- 2️⃣ Billing (APPENDABLE) ---- */
    const kitchenOrders =
      JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];

    const existingOrder = kitchenOrders.find(
      o => o.table === table && o.status === "Open"
    );

    if (existingOrder) {
      for (const key in cart) {
        if (existingOrder.items[key]) {
          existingOrder.items[key].qty += cart[key].qty;
        } else {
          existingOrder.items[key] = cart[key];
        }
      }
    } else {
      kitchenOrders.push({
        table,
        items: cart,
        payment: "",
        status: "Open",
        time: new Date().toLocaleString()
      });
    }

    localStorage.setItem(KITCHEN_KEY, JSON.stringify(kitchenOrders));

    /* ---- 3️⃣ Clear Cart ---- */
    localStorage.removeItem(CART_KEY);
    alert("Order sent to kitchen!");
    location.href = `index.html?table=${table}`;
  };

  renderCart();
});
</script>

</body>
</html>
