<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Your Order</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4efe8;
  padding: 20px;
}

.container {
  max-width: 600px;
  margin: auto;
  background: #ffffff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

h1 {
  text-align: center;
}

.table-info {
  text-align: center;
  font-weight: bold;
  margin-bottom: 10px;
}

#cartItems .row {
  display: flex;
  justify-content: space-between;
  margin: 8px 0;
}

.total {
  font-size: 18px;
  font-weight: bold;
  text-align: right;
  margin-top: 15px;
}

button {
  width: 100%;
  margin-top: 20px;
  padding: 14px;
  font-size: 16px;
  background: #3fa55b;
  color: white;
  border: none;
  border-radius: 999px;
  cursor: pointer;
}

button:hover {
  background: #2f8c4c;
}

.back-link {
  display: block;
  text-align: center;
  margin-top: 15px;
  text-decoration: none;
  color: #7b4b2a;
  font-weight: bold;
}

.empty {
  text-align: center;
  color: #666;
}
</style>
</head>

<body>

<div class="container">
  <h1>Your Order</h1>
  <div id="tableInfo" class="table-info"></div>

  <!-- Cart Items -->
  <div id="cartItems"></div>

  <!-- Total -->
  <div id="total" class="total"></div>

  <!-- Place Order -->
  <button onclick="placeOrder()">Place Order</button>

  <!-- Back to Menu -->
  <a id="backLink" class="back-link">← Back to Menu</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  /* =========================
     TABLE NUMBER
  ========================= */
  const params = new URLSearchParams(window.location.search);
  const table = params.get("table") || "default";

  const CART_KEY = `cart_table_${table}`;
  const KITCHEN_KEY = "kitchen_orders";
  const QUEUE_KEY = "kitchen_queue";

  document.getElementById("tableInfo").innerText =
    `Table No: ${table}`;

  document.getElementById("backLink").href =
    `index.html?table=${table}`;

  /* =========================
     LOAD CART
  ========================= */
  const cart = JSON.parse(localStorage.getItem(CART_KEY)) || {};
  const cartItemsDiv = document.getElementById("cartItems");
  const totalDiv = document.getElementById("total");

  let total = 0;

  if (Object.keys(cart).length === 0) {
    cartItemsDiv.innerHTML =
      `<p class="empty">Your cart is empty</p>`;
    totalDiv.innerText = "";
    return;
  }

  Object.values(cart).forEach(item => {
    const itemTotal = item.price * item.qty;
    total += itemTotal;

    cartItemsDiv.innerHTML += `
      <div class="row">
        <span>${item.name} × ${item.qty}</span>
        <span>₹${itemTotal}</span>
      </div>
    `;
  });

  totalDiv.innerText = `Total: ₹${total}`;

  /* =========================
     PLACE ORDER
     → Kitchen Queue (NO APPEND)
     → Billing (APPENDABLE)
  ========================= */
  window.placeOrder = function () {

    /* -------- 1️⃣ PUSH TO KITCHEN QUEUE -------- */
    const queue =
      JSON.parse(localStorage.getItem(QUEUE_KEY)) || [];

    queue.push({
      table: table,
      items: JSON.parse(JSON.stringify(cart)), // snapshot
      status: "Pending",
      time: new Date().toLocaleString()
    });

    localStorage.setItem(QUEUE_KEY, JSON.stringify(queue));

    /* -------- 2️⃣ BILLING (APPEND LOGIC) -------- */
    const kitchenOrders =
      JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];

    const existingOrder = kitchenOrders.find(
      o => o.table === table && o.status === "Open"
    );

    if (existingOrder) {
      // Append items for same table
      for (const key in cart) {
        if (existingOrder.items[key]) {
          existingOrder.items[key].qty += cart[key].qty;
        } else {
          existingOrder.items[key] = cart[key];
        }
      }
    } else {
      kitchenOrders.push({
        table: table,
        items: cart,
        payment: "",
        status: "Open",
        time: new Date().toLocaleString()
      });
    }

    localStorage.setItem(KITCHEN_KEY, JSON.stringify(kitchenOrders));

    /* -------- 3️⃣ CLEAR CART -------- */
    localStorage.removeItem(CART_KEY);

    alert("Order sent to kitchen!");
    window.location.href = `index.html?table=${table}`;
  };

});
</script>

</body>
</html>
