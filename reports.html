<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f6f1e7;
  padding:20px;
}

h2 {
  text-align:center;
}

.block {
  background:#fff;
  padding:16px;
  border-radius:10px;
  margin-bottom:20px;
  box-shadow:0 3px 8px rgba(0,0,0,0.15);
}

button {
  padding:10px 14px;
  margin:6px 6px 6px 0;
  border:none;
  border-radius:999px;
  background:#3fa55b;
  color:#fff;
  cursor:pointer;
}

.bill {
  border-bottom:1px dashed #ccc;
  padding:10px 0;
}

.bill:last-child {
  border-bottom:none;
}

.item {
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin:3px 0;
}

.total {
  text-align:right;
  font-weight:bold;
  margin-top:6px;
}

.summary {
  font-size:16px;
  font-weight:bold;
  text-align:right;
}
</style>
</head>

<body>

<h2>üìä Reports</h2>

<!-- ================= QUICK REPORTS ================= -->
<div class="block">
  <h3>Quick Reports</h3>
  <button onclick="dailyReport()">üìÖ Daily Report</button>
  <button onclick="exportDailyCSV()">‚¨á Daily CSV</button>
  <br>
  <button onclick="monthlyReport()">üìÜ Monthly Report</button>
  <button onclick="exportMonthlyCSV()">‚¨á Monthly CSV</button>
  <br>
  <button onclick="monthlySummary()">üìä Monthly Summary (Day-wise)</button>

  <div id="quickOutput" style="margin-top:10px;"></div>
</div>

<!-- ================= DATE RANGE ================= -->
<div class="block">
  <h3>üîç Date Range Report</h3>
  From <input type="date" id="from">
  To <input type="date" id="to">
  <br><br>
  <button onclick="dateFilter()">Apply</button>
  <button onclick="exportRangeCSV()">‚¨á Export CSV</button>
</div>

<!-- ================= DETAILED ================= -->
<div class="block" id="details"></div>

<div class="block summary" id="grandTotal"></div>

<script>
const CLOSED_KEY = "closed_bills";

/* ================= DAILY ================= */
function dailyReport() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const today = new Date().toDateString();
  let total = 0;

  bills.filter(b => new Date(b.time).toDateString() === today)
       .forEach(b => total += b.total);

  document.getElementById("quickOutput").innerText =
    `Today‚Äôs Total: ‚Çπ${total.toFixed(2)}`;
}

/* ================= MONTHLY ================= */
function monthlyReport() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const now = new Date();
  let total = 0;

  bills.filter(b => {
    const d = new Date(b.time);
    return d.getMonth() === now.getMonth() &&
           d.getFullYear() === now.getFullYear();
  }).forEach(b => total += b.total);

  document.getElementById("quickOutput").innerText =
    `This Month Total: ‚Çπ${total.toFixed(2)}`;
}

/* ================= MONTHLY SUMMARY ================= */
function monthlySummary() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const now = new Date();
  const map = {};

  bills.forEach(b => {
    const d = new Date(b.time);
    if (d.getMonth() === now.getMonth() &&
        d.getFullYear() === now.getFullYear()) {
      const day = d.toDateString();
      map[day] = (map[day] || 0) + b.total;
    }
  });

  let html = "<b>Day-wise Summary</b><br>";
  for (const day in map) {
    html += `${day} : ‚Çπ${map[day].toFixed(2)}<br>`;
  }

  document.getElementById("quickOutput").innerHTML = html;
}

/* ================= DATE FILTER ================= */
function dateFilter() {
  const fromVal = document.getElementById("from").value;
  const toVal = document.getElementById("to").value;

  if (!fromVal || !toVal) {
    alert("Select both From and To dates");
    return;
  }

  const from = new Date(fromVal);
  const to = new Date(toVal);
  to.setHours(23,59,59,999);

  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const div = document.getElementById("details");
  const totalDiv = document.getElementById("grandTotal");

  div.innerHTML = "";
  totalDiv.innerHTML = "";

  let grand = 0;

  bills.filter(b => {
    const d = new Date(b.time);
    return d >= from && d <= to;
  }).forEach(b => {

    let itemsHTML = "";
    for (const k in b.items) {
      const i = b.items[k];
      itemsHTML += `
        <div class="item">
          <span>${i.name} √ó ${i.qty}</span>
          <span>‚Çπ${i.price * i.qty}</span>
        </div>`;
    }

    if (b.discountAmount > 0) {
      itemsHTML += `
        <div class="item">
          <span>Discount (${b.discountPercent}%)</span>
          <span>-‚Çπ${b.discountAmount.toFixed(2)}</span>
        </div>`;
    }

    grand += b.total;

    div.innerHTML += `
      <div class="bill">
        <b>Table ${b.table}</b><br>
        <small>${new Date(b.time).toLocaleString()}</small>
        ${itemsHTML}
        <div class="total">‚Çπ${b.total.toFixed(2)}</div>
      </div>
    `;
  });

  totalDiv.innerText = `Grand Total: ‚Çπ${grand.toFixed(2)}`;
}

/* ================= CSV HELPERS ================= */
function downloadCSV(rows, filename) {
  const csv = rows.map(r => r.map(v => `"${v}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type:"text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/* ================= DAILY CSV ================= */
function exportDailyCSV() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const today = new Date().toDateString();

  let rows = [
    ["Date","Table","Item","Qty","Price",
     "Discount %","Discount Amount","Bill Total","Payment"]
  ];

  bills.filter(b => new Date(b.time).toDateString() === today)
       .forEach(b => {
         for (const k in b.items) {
           const i = b.items[k];
           rows.push([
             new Date(b.time).toLocaleDateString(),
             b.table,
             i.name,
             i.qty,
             i.price,
             b.discountPercent || 0,
             b.discountAmount || 0,
             b.total,
             b.payment
           ]);
         }
       });

  if (rows.length === 1) {
    alert("No data for today");
    return;
  }

  downloadCSV(rows, "daily_report.csv");
}

/* ================= MONTHLY CSV ================= */
function exportMonthlyCSV() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const now = new Date();

  let rows = [
    ["Date","Table","Item","Qty","Price",
     "Discount %","Discount Amount","Bill Total","Payment"]
  ];

  bills.filter(b => {
    const d = new Date(b.time);
    return d.getMonth() === now.getMonth() &&
           d.getFullYear() === now.getFullYear();
  }).forEach(b => {
    for (const k in b.items) {
      const i = b.items[k];
      rows.push([
        new Date(b.time).toLocaleDateString(),
        b.table,
        i.name,
        i.qty,
        i.price,
        b.discountPercent || 0,
        b.discountAmount || 0,
        b.total,
        b.payment
      ]);
    }
  });

  if (rows.length === 1) {
    alert("No data this month");
    return;
  }

  downloadCSV(rows, "monthly_report.csv");
}

/* ================= RANGE CSV ================= */
function exportRangeCSV() {
  const fromVal = document.getElementById("from").value;
  const toVal = document.getElementById("to").value;

  if (!fromVal || !toVal) {
    alert("Select From and To dates");
    return;
  }

  const from = new Date(fromVal);
  const to = new Date(toVal);
  to.setHours(23,59,59,999);

  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];

  let rows = [
    ["Date","Table","Item","Qty","Price",
     "Discount %","Discount Amount","Bill Total","Payment"]
  ];

  bills.filter(b => {
    const d = new Date(b.time);
    return d >= from && d <= to;
  }).forEach(b => {
    for (const k in b.items) {
      const i = b.items[k];
      rows.push([
        new Date(b.time).toLocaleDateString(),
        b.table,
        i.name,
        i.qty,
        i.price,
        b.discountPercent || 0,
        b.discountAmount || 0,
        b.total,
        b.payment
      ]);
    }
  });

  if (rows.length === 1) {
    alert("No data in range");
    return;
  }

  downloadCSV(rows, "range_report.csv");
}
</script>

</body>
</html>
