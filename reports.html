<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- üîê AUTH PROTECTION -->
<script>
(function () {
  const auth = localStorage.getItem("admin_auth");
  const time = localStorage.getItem("admin_auth_time");

  if (!auth || !time || Date.now() - time > 30 * 60 * 1000) {
    localStorage.removeItem("admin_auth");
    localStorage.removeItem("admin_auth_time");
    location.href = "admin-login.html?redirect=reports.html";
  }
})();
</script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f6f1e7;
  padding:20px;
}

.container {
  max-width: 1000px;
  margin:auto;
}

h1 {
  text-align:center;
}

.block {
  background:#ffffff;
  padding:16px;
  border-radius:10px;
  margin-bottom:20px;
  box-shadow:0 3px 8px rgba(0,0,0,0.15);
}

button {
  padding:10px 14px;
  margin:6px 6px 6px 0;
  border:none;
  border-radius:999px;
  background:#3fa55b;
  color:#fff;
  cursor:pointer;
}

button.secondary {
  background:#7b4b2a;
}

.bill {
  border-bottom:1px dashed #ccc;
  padding:10px 0;
}

.bill:last-child {
  border-bottom:none;
}

.item {
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin:3px 0;
}

.total {
  text-align:right;
  font-weight:bold;
  margin-top:6px;
}

.summary {
  font-size:16px;
  font-weight:bold;
  text-align:right;
}

.logout {
  background:#b33939;
}
</style>
</head>

<body>

<div class="container">
  <h1>üìä Reports</h1>

  <!-- ================= QUICK REPORTS ================= -->
  <div class="block">
    <h3>Quick Reports</h3>
    <button onclick="dailyReport()">üìÖ Daily Report</button>
    <button onclick="exportDailyCSV()">‚¨á Export Daily CSV</button>

    <br>

    <button onclick="monthlyReport()">üìÜ Monthly Report</button>
    <button onclick="exportMonthlyCSV()">‚¨á Export Monthly CSV</button>

    <br>

    <button onclick="monthlySummary()">üìä Monthly Summary</button>

    <div id="quickReport"></div>
  </div>

  <!-- ================= DATE FILTER ================= -->
  <div class="block">
    <h3>üîç Date Range Report</h3>
    From <input type="date" id="from">
    To <input type="date" id="to">

    <br><br>

    <button onclick="dateFilter()">Apply</button>
    <button onclick="exportCSV()">‚¨á Export CSV</button>
  </div>

  <!-- ================= DETAILED REPORT ================= -->
  <div class="block" id="detailed"></div>

  <!-- ================= GRAND TOTAL ================= -->
  <div class="block summary" id="grandTotal"></div>

  <button class="logout" onclick="logout()">Logout</button>
</div>

<script>
const CLOSED_KEY = "closed_bills";

/* ========== DAILY REPORT ========== */
function dailyReport() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const today = new Date().toDateString();
  let total = 0;

  bills.filter(b => new Date(b.time).toDateString() === today)
       .forEach(b => total += b.total);

  document.getElementById("quickReport").innerHTML =
    `Today‚Äôs Total: ‚Çπ${total.toFixed(2)}`;
}

/* ========== MONTHLY REPORT ========== */
function monthlyReport() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const m = new Date().getMonth();
  const y = new Date().getFullYear();
  let total = 0;

  bills.filter(b => {
    const d = new Date(b.time);
    return d.getMonth() === m && d.getFullYear() === y;
  }).forEach(b => total += b.total);

  document.getElementById("quickReport").innerHTML =
    `This Month Total: ‚Çπ${total.toFixed(2)}`;
}

/* ========== MONTHLY SUMMARY (DAY-WISE) ========== */
function monthlySummary() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const m = new Date().getMonth();
  const y = new Date().getFullYear();
  const map = {};

  bills.forEach(b => {
    const d = new Date(b.time);
    if (d.getMonth() === m && d.getFullYear() === y) {
      const day = d.toDateString();
      map[day] = (map[day] || 0) + b.total;
    }
  });

  let html = "<b>Day-wise Summary</b><br>";
  for (const day in map) {
    html += `${day} : ‚Çπ${map[day].toFixed(2)}<br>`;
  }

  document.getElementById("quickReport").innerHTML = html;
}

/* ========== DATE FILTER (SCREEN) ========== */
function dateFilter() {
  const fromVal = document.getElementById("from").value;
  const toVal = document.getElementById("to").value;

  if (!fromVal || !toVal) {
    alert("Select both From and To dates");
    return;
  }

  const from = new Date(fromVal);
  const to = new Date(toVal);
  to.setHours(23,59,59,999);

  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const div = document.getElementById("detailed");
  const totalDiv = document.getElementById("grandTotal");

  div.innerHTML = "";
  totalDiv.innerHTML = "";

  let grand = 0;

  bills.filter(b => {
    const d = new Date(b.time);
    return d >= from && d <= to;
  }).forEach(b => {

    let itemsHTML = "";
    for (const k in b.items) {
      const i = b.items[k];
      itemsHTML += `
        <div class="item">
          <span>${i.name} √ó ${i.qty}</span>
          <span>‚Çπ${i.price * i.qty}</span>
        </div>`;
    }

    grand += b.total;

    div.innerHTML += `
      <div class="bill">
        <b>Table ${b.table}</b><br>
        <small>${new Date(b.time).toLocaleString()}</small>
        ${itemsHTML}
        <div class="total">‚Çπ${b.total.toFixed(2)}</div>
      </div>
    `;
  });

  totalDiv.innerHTML = `Grand Total: ‚Çπ${grand.toFixed(2)}`;
}

/* ========== CSV EXPORT (DATE FILTER) ========== */
function exportCSV() {
  const fromVal = document.getElementById("from").value;
  const toVal = document.getElementById("to").value;

  if (!fromVal || !toVal) {
    alert("Select From and To dates");
    return;
  }

  const from = new Date(fromVal);
  const to = new Date(toVal);
  to.setHours(23,59,59,999);

  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];

  let rows = [
    ["Date","Table","Item","Qty","Price","Line Total","Bill Total","Payment"]
  ];

  bills.filter(b => {
    const d = new Date(b.time);
    return d >= from && d <= to;
  }).forEach(b => {
    for (const k in b.items) {
      const i = b.items[k];
      rows.push([
        new Date(b.time).toLocaleDateString(),
        b.table,
        i.name,
        i.qty,
        i.price,
        i.price * i.qty,
        b.total,
        b.payment
      ]);
    }
  });

  if (rows.length === 1) {
    alert("No data to export");
    return;
  }

  downloadCSV(rows, `sales_${fromVal}_to_${toVal}.csv`);
}

/* ========== DAILY CSV ========== */
function exportDailyCSV() {
  const today = new Date().toDateString();
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];

  let rows = [["Date","Table","Item","Qty","Price","Line Total","Bill Total","Payment"]];

  bills.filter(b => new Date(b.time).toDateString() === today)
       .forEach(b => {
         for (const k in b.items) {
           const i = b.items[k];
           rows.push([
             new Date(b.time).toLocaleDateString(),
             b.table,
             i.name,
             i.qty,
             i.price,
             i.price * i.qty,
             b.total,
             b.payment
           ]);
         }
       });

  if (rows.length === 1) {
    alert("No bills for today");
    return;
  }

  downloadCSV(rows, `daily_report_${new Date().toISOString().slice(0,10)}.csv`);
}

/* ========== MONTHLY CSV ========== */
function exportMonthlyCSV() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const now = new Date();
  const m = now.getMonth();
  const y = now.getFullYear();

  let rows = [["Date","Table","Item","Qty","Price","Line Total","Bill Total","Payment"]];

  bills.filter(b => {
    const d = new Date(b.time);
    return d.getMonth() === m && d.getFullYear() === y;
  }).forEach(b => {
    for (const k in b.items) {
      const i = b.items[k];
      rows.push([
        new Date(b.time).toLocaleDateString(),
        b.table,
        i.name,
        i.qty,
        i.price,
        i.price * i.qty,
        b.total,
        b.payment
      ]);
    }
  });

  if (rows.length === 1) {
    alert("No bills this month");
    return;
  }

  downloadCSV(rows, `monthly_report_${y}_${m+1}.csv`);
}

/* ========== CSV HELPER ========== */
function downloadCSV(rows, filename) {
  const csv = rows.map(r => r.map(v => `"${v}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type:"text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ========== LOGOUT ========== */
function logout() {
  localStorage.removeItem("admin_auth");
  localStorage.removeItem("admin_auth_time");
  location.href = "admin-login.html";
}
</script>

</body>
</html>
