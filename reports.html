<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reports</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- üîê ADMIN AUTH CHECK -->
<script>
(function () {
  const auth = localStorage.getItem("admin_auth");
  const time = localStorage.getItem("admin_auth_time");

  if (!auth || !time || Date.now() - time > 30 * 60 * 1000) {
    localStorage.removeItem("admin_auth");
    localStorage.removeItem("admin_auth_time");
    location.href = "report-admin.html?redirect=reports.html";
  }
})();
</script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f6f1e7;
  padding:20px;
}

h2 {
  text-align:center;
}

.block {
  background:#fff;
  padding:16px;
  border-radius:10px;
  margin-bottom:20px;
  box-shadow:0 3px 8px rgba(0,0,0,0.15);
}

button {
  padding:10px 14px;
  margin:6px 6px 6px 0;
  border:none;
  border-radius:999px;
  background:#3fa55b;
  color:#fff;
  cursor:pointer;
}

.bill {
  border-bottom:1px dashed #ccc;
  padding:10px 0;
}

.bill:last-child {
  border-bottom:none;
}

.item {
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin:3px 0;
}

.total {
  text-align:right;
  font-weight:bold;
  margin-top:6px;
}

.summary {
  font-size:16px;
  font-weight:bold;
  text-align:right;
}

.logout {
  background:#b33939;
  float:right;
}
</style>
</head>

<body>

<h2>üìä Reports</h2>
<button class="logout" onclick="logout()">Logout</button>

<!-- QUICK REPORTS -->
<div class="block">
  <h3>Quick Reports</h3>
  <button onclick="dailyReport()">üìÖ Daily</button>
  <button onclick="exportDailyCSV()">‚¨á Daily CSV</button>
  <br>
  <button onclick="monthlyReport()">üìÜ Monthly</button>
  <button onclick="exportMonthlyCSV()">‚¨á Monthly CSV</button>
  <br>
  <button onclick="monthlySummary()">üìä Monthly Summary</button>

  <div id="quickOutput" style="margin-top:10px;"></div>
</div>

<!-- DATE RANGE -->
<div class="block">
  <h3>üîç Date Range</h3>
  From <input type="date" id="from">
  To <input type="date" id="to">
  <br><br>
  <button onclick="dateFilter()">Apply</button>
  <button onclick="exportRangeCSV()">‚¨á Export CSV</button>
</div>

<!-- DETAILS -->
<div class="block" id="details"></div>
<div class="block summary" id="grandTotal"></div>

<script>
const CLOSED_KEY = "closed_bills";

/* ===== DAILY ===== */
function dailyReport() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const today = new Date().toDateString();
  let total = 0;

  bills.filter(b => new Date(b.time).toDateString() === today)
       .forEach(b => total += b.total);

  quickOutput.innerText = `Today‚Äôs Total: ‚Çπ${total.toFixed(2)}`;
}

/* ===== MONTHLY ===== */
function monthlyReport() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const now = new Date();
  let total = 0;

  bills.filter(b => {
    const d = new Date(b.time);
    return d.getMonth() === now.getMonth() &&
           d.getFullYear() === now.getFullYear();
  }).forEach(b => total += b.total);

  quickOutput.innerText = `This Month Total: ‚Çπ${total.toFixed(2)}`;
}

/* ===== MONTHLY SUMMARY ===== */
function monthlySummary() {
  const bills = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const now = new Date();
  const map = {};

  bills.forEach(b => {
    const d = new Date(b.time);
    if (d.getMonth() === now.getMonth() &&
        d.getFullYear() === now.getFullYear()) {
      const day = d.toDateString();
      map[day] = (map[day] || 0) + b.total;
    }
  });

  let html = "<b>Day-wise Summary</b><br>";
  for (const day in map) {
    html += `${day} : ‚Çπ${map[day].toFixed(2)}<br>`;
  }

  quickOutput.innerHTML = html;
}

/* ===== DATE FILTER ===== */
function dateFilter() {
  const f = new Date(from.value);
  const t = new Date(to.value);
  t.setHours(23,59,59,999);

  details.innerHTML = "";
  grandTotal.innerHTML = "";
  let grand = 0;

  (JSON.parse(localStorage.getItem(CLOSED_KEY)) || [])
    .filter(b => new Date(b.time) >= f && new Date(b.time) <= t)
    .forEach(b => {

      let itemsHTML = "";
      for (const k in b.items) {
        const i = b.items[k];
        itemsHTML += `
          <div class="item">
            <span>${i.name} √ó ${i.qty}</span>
            <span>‚Çπ${i.price * i.qty}</span>
          </div>`;
      }

      if (b.discountAmount > 0) {
        itemsHTML += `
          <div class="item">
            <span>Discount (${b.discountPercent}%)</span>
            <span>-‚Çπ${b.discountAmount.toFixed(2)}</span>
          </div>`;
      }

      grand += b.total;

      details.innerHTML += `
        <div class="bill">
          <b>Table ${b.table}</b><br>
          <small>${new Date(b.time).toLocaleString()}</small>
          ${itemsHTML}
          <div class="total">‚Çπ${b.total.toFixed(2)}</div>
        </div>`;
    });

  grandTotal.innerText = `Grand Total: ‚Çπ${grand.toFixed(2)}`;
}

/* ===== CSV EXPORTS ===== */
function downloadCSV(rows, name) {
  const csv = rows.map(r => r.map(v => `"${v}"`).join(",")).join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
  a.download = name;
  a.click();
}

function exportDailyCSV() {
  const today = new Date().toDateString();
  const rows = [["Date","Table","Discount %","Discount Amt","Total"]];
  (JSON.parse(localStorage.getItem(CLOSED_KEY)) || [])
    .filter(b => new Date(b.time).toDateString() === today)
    .forEach(b => rows.push([
      new Date(b.time).toLocaleDateString(),
      b.table,
      b.discountPercent || 0,
      b.discountAmount || 0,
      b.total
    ]));
  downloadCSV(rows,"daily_report.csv");
}

function exportMonthlyCSV() {
  const now = new Date();
  const rows = [["Date","Table","Discount %","Discount Amt","Total"]];
  (JSON.parse(localStorage.getItem(CLOSED_KEY)) || [])
    .filter(b => new Date(b.time).getMonth() === now.getMonth())
    .forEach(b => rows.push([
      new Date(b.time).toLocaleDateString(),
      b.table,
      b.discountPercent || 0,
      b.discountAmount || 0,
      b.total
    ]));
  downloadCSV(rows,"monthly_report.csv");
}

function exportRangeCSV() {
  const f = new Date(from.value);
  const t = new Date(to.value);
  t.setHours(23,59,59,999);

  const rows = [["Date","Table","Discount %","Discount Amt","Total"]];
  (JSON.parse(localStorage.getItem(CLOSED_KEY)) || [])
    .filter(b => new Date(b.time) >= f && new Date(b.time) <= t)
    .forEach(b => rows.push([
      new Date(b.time).toLocaleDateString(),
      b.table,
      b.discountPercent || 0,
      b.discountAmount || 0,
      b.total
    ]));
  downloadCSV(rows,"range_report.csv");
}

/* ===== LOGOUT ===== */
function logout() {
  localStorage.removeItem("admin_auth");
  localStorage.removeItem("admin_auth_time");
  location.href = "admin-login.html";
}
</script>

</body>
</html>
