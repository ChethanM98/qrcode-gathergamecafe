<!DOCTYPE html>
<html>
<head>
<title>Billing</title>

<style>
body { font-family: Arial; background:#f2f2f2; padding:20px; }

.order-box {
  background:#fff;
  padding:16px;
  margin-bottom:20px;
  border-radius:10px;
  border:2px solid #333;
  page-break-inside: avoid;
}

.table-title { font-size:18px; font-weight:bold; }
.items { border-top:1px solid #ccc; border-bottom:1px solid #ccc; padding:10px 0; }
.item-row { display:flex; justify-content:space-between; margin:6px 0; }
.total { text-align:right; font-weight:bold; margin-top:10px; line-height:1.6; }

.actions {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:12px;
}

select, button { padding:8px 12px; font-size:14px; }

.print-btn { background:#7b4b2a; color:#fff; border:none; }
.close-btn { background:#3fa55b; color:#fff; border:none; }

@media print {
  body * { visibility:hidden; }
  .print-area, .print-area * { visibility:visible; }
  .print-area {
    position:absolute;
    left:0; top:0;
    width:80mm;
    font-size:12px;
  }
  button, select { display:none; }
}
</style>
</head>

<body>

<h1>üçΩÔ∏è Kitchen & Billing</h1>
<div id="orders"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const KITCHEN_KEY = "kitchen_orders";
  const CLOSED_KEY = "closed_bills";
  const ordersDiv = document.getElementById("orders");

  loadOrders();
  setInterval(loadOrders, 10000); // auto-refresh

  function loadOrders() {
    const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
    ordersDiv.innerHTML = "";

    if (orders.length === 0) {
      ordersDiv.innerHTML = "<p>No open orders</p>";
      return;
    }

    orders.forEach(order => {
      let itemsHTML = "";
      let subTotal = 0;

      for (const k in order.items) {
        const i = order.items[k];
        const line = i.price * i.qty;
        subTotal += line;

        itemsHTML += `
          <div class="item-row">
            <span>${i.name} √ó ${i.qty}</span>
            <span>‚Çπ${line.toFixed(2)}</span>
          </div>`;
      }

      const cgst = subTotal * 0.025;
      const sgst = subTotal * 0.025;
      const grand = subTotal + cgst + sgst;

      ordersDiv.innerHTML += `
        <div class="order-box print-area">
          <div class="table-title">Table ${order.table}</div>

          <div class="items">
            ${itemsHTML}
            <div class="total">
              Subtotal: ‚Çπ${subTotal.toFixed(2)}<br>
              CGST: ‚Çπ${cgst.toFixed(2)}<br>
              SGST: ‚Çπ${sgst.toFixed(2)}<br>
              <strong>Grand Total: ‚Çπ${grand.toFixed(2)}</strong>
            </div>
          </div>

          <div class="actions">
            <select onchange="setPayment('${order.table}', this.value)">
              <option value="">Payment</option>
              <option value="Cash" ${order.payment==="Cash"?"selected":""}>Cash</option>
              <option value="UPI" ${order.payment==="UPI"?"selected":""}>UPI</option>
            </select>

            <div>
              <button class="print-btn" onclick="printThis(this)">Print</button>
              <button class="close-btn"
                onclick="closeBill('${order.table}', ${subTotal}, ${cgst}, ${sgst}, ${grand})">
                Close Bill
              </button>
            </div>
          </div>
        </div>`;
    });
  }

  window.setPayment = (table, method) => {
    const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
    const o = orders.find(x => x.table === table);
    if (o) {
      o.payment = method;
      localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));
    }
  };

  window.closeBill = (table, sub, cgst, sgst, grand) => {
    let orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
    let closed = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];

    const idx = orders.findIndex(o => o.table === table);
    if (idx === -1) return;
    if (!orders[idx].payment) return alert("Select payment method");

    const now = new Date();
    closed.push({
      table,
      items: orders[idx].items,
      subTotal: sub,
      cgst, sgst,
      grandTotal: grand,
      payment: orders[idx].payment,
      date: now.toISOString().slice(0,10),
      month: now.toISOString().slice(0,7)
    });

    orders.splice(idx, 1);
    localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));
    localStorage.setItem(CLOSED_KEY, JSON.stringify(closed));
    loadOrders();
  };

  window.printThis = btn => {
    const box = btn.closest(".order-box");
    document.querySelectorAll(".order-box").forEach(b => {
      if (b !== box) b.style.display = "none";
    });
    window.print();
    document.querySelectorAll(".order-box").forEach(b => b.style.display = "");
  };

});
</script>

</body>
</html>

