<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Billing</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ðŸ” ADMIN AUTH CHECK -->
<script>
(function () {
  const auth = localStorage.getItem("admin_auth");
  const time = localStorage.getItem("admin_auth_time");

  if (!auth || !time || Date.now() - time > 30 * 60 * 1000) {
    localStorage.removeItem("admin_auth");
    localStorage.removeItem("admin_auth_time");
    location.href = "admin-login.html?redirect=admin.html";
  }
})();
</script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f6f1e7;
  padding:20px;
}

h2 {
  text-align:center;
  margin-bottom:15px;
}

/* ===== TABLE GRID ===== */
.tables {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(90px,1fr));
  gap:12px;
  margin-bottom:20px;
}

.table-card {
  background:#ffffff;
  border-radius:14px;
  padding:20px 10px;
  text-align:center;
  cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,0.15);
  font-weight:bold;
  transition:transform 0.15s ease;
}

.table-card:hover {
  transform:translateY(-2px);
}

.table-card.active {
  background:#3fa55b;
  color:#fff;
}

.table-card.empty {
  opacity:0.45;
}

/* ===== BILL ===== */
.bill {
  background:#fff;
  padding:18px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
  margin-bottom:30px;
}

.row {
  display:flex;
  justify-content:space-between;
  margin:4px 0;
  font-size:14px;
}

input, select, button {
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:999px;
  border:1px solid #ccc;
  font-size:14px;
}

button {
  background:#3fa55b;
  color:#fff;
  border:none;
  cursor:pointer;
}

button.danger {
  background:#b33939;
}

.hidden {
  display:none;
}

/* ===== PRINT ===== */
@media print {
  body * { visibility:hidden; }
  .bill, .bill * { visibility:visible; }
  .bill {
    position:absolute;
    left:0;
    top:0;
    width:80mm;
  }
  input, select, button { display:none !important; }
}
</style>
</head>

<body>

<h2>ðŸ§¾ Admin Billing</h2>

<!-- TABLE GRID -->
<div class="tables" id="tables"></div>

<!-- BILL AREA -->
<div id="billArea" class="hidden"></div>

<script>
const TOTAL_TABLES = 15;
const KITCHEN_KEY = "kitchen_orders";
const CLOSED_KEY = "closed_bills";

/* ========== INIT ========== */
renderTables();

/* ========== TABLE GRID ========== */
function renderTables() {
  const tablesDiv = document.getElementById("tables");
  const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
  tablesDiv.innerHTML = "";

  for (let i = 1; i <= TOTAL_TABLES; i++) {
    const active = orders.find(o => o.table == i);
    tablesDiv.innerHTML += `
      <div class="table-card ${active ? "active" : "empty"}"
           onclick="openTable(${i})">
        Table ${i}
      </div>
    `;
  }
}

/* ========== OPEN TABLE ========== */
function openTable(tableNo) {
  const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
  const order = orders.find(o => o.table == tableNo);
  const billDiv = document.getElementById("billArea");

  if (!order) {
    billDiv.classList.remove("hidden");
    billDiv.innerHTML = `<p>No active order for Table ${tableNo}</p>`;
    return;
  }

  let subtotal = 0;
  let rows = "";

  for (const k in order.items) {
    const i = order.items[k];
    const amt = i.price * i.qty;
    subtotal += amt;
    rows += `<div class="row"><span>${i.name} Ã— ${i.qty}</span><span>â‚¹${amt}</span></div>`;
  }

  const dp = order.discount || 0;
  const da = +(subtotal * dp / 100).toFixed(2);
  const ds = subtotal - da;
  const cgst = +(ds * 0.025).toFixed(2);
  const sgst = +(ds * 0.025).toFixed(2);
  const total = +(ds + cgst + sgst).toFixed(2);

  billDiv.classList.remove("hidden");
  billDiv.innerHTML = `
    <div class="bill">
      <center>
        <b>Gather & Game CafÃ©</b><br>
        Play Â· Sip Â· Repeat
      </center>
      <hr>

      <b>Table ${tableNo}</b><br><br>

      ${rows}

      <div class="row"><span>Subtotal</span><span>â‚¹${subtotal.toFixed(2)}</span></div>
      ${da > 0 ? `<div class="row"><span>Discount (${dp}%)</span><span>-â‚¹${da.toFixed(2)}</span></div>` : ""}
      <div class="row"><span>CGST (2.5%)</span><span>â‚¹${cgst.toFixed(2)}</span></div>
      <div class="row"><span>SGST (2.5%)</span><span>â‚¹${sgst.toFixed(2)}</span></div>
      <div class="row"><b>Total</b><b>â‚¹${total.toFixed(2)}</b></div>

      <input type="number"
             min="0" max="100"
             value="${dp}"
             placeholder="Discount %"
             onchange="setDiscount(${tableNo}, this.value)">

      <select onchange="setPayment(${tableNo}, this.value)">
        <option value="">Payment Method</option>
        <option value="Cash">Cash</option>
        <option value="UPI">UPI</option>
      </select>

      <button onclick="window.print()">ðŸ–¨ Print Bill</button>
      <button class="danger" onclick="closeBill(${tableNo})">Close Bill</button>

      <hr>
      <center>
        Game On<br>
        Where food meets fun
      </center>
    </div>
  `;
}

/* ========== DISCOUNT ========== */
function setDiscount(table, value) {
  let orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
  const o = orders.find(x => x.table == table);
  if (!o) return;
  o.discount = Math.min(100, Math.max(0, +value || 0));
  localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));
  openTable(table);
}

/* ========== PAYMENT ========== */
function setPayment(table, value) {
  let orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
  const o = orders.find(x => x.table == table);
  if (o) {
    o.payment = value;
    localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));
  }
}

/* ========== CLOSE BILL ========== */
function closeBill(table) {
  let orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
  let closed = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];
  const idx = orders.findIndex(o => o.table == table);
  if (idx === -1) return;

  const o = orders[idx];

  let subtotal = 0;
  for (const k in o.items) subtotal += o.items[k].price * o.items[k].qty;

  const dp = o.discount || 0;
  const da = +(subtotal * dp / 100).toFixed(2);
  const ds = subtotal - da;
  const cgst = +(ds * 0.025).toFixed(2);
  const sgst = +(ds * 0.025).toFixed(2);
  const total = +(ds + cgst + sgst).toFixed(2);

  closed.push({
    table,
    items: o.items,
    subtotal,
    discountPercent: dp,
    discountAmount: da,
    cgst,
    sgst,
    total,
    payment: o.payment || "Cash",
    time: new Date().toISOString()
  });

  orders.splice(idx, 1);
  localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));
  localStorage.setItem(CLOSED_KEY, JSON.stringify(closed));

  document.getElementById("billArea").classList.add("hidden");
  renderTables();
}
</script>

</body>
</html>
