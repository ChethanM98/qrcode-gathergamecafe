<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin POS</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f2f2f2;
  padding:20px;
}

h1 {
  text-align:center;
}

.order {
  background:#fff;
  padding:16px;
  margin-bottom:20px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
}

.order h2 {
  margin:0 0 10px 0;
}

.item {
  display:flex;
  justify-content:space-between;
  margin:6px 0;
}

.summary {
  margin-top:10px;
  border-top:1px dashed #ccc;
  padding-top:10px;
}

.summary div {
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}

.actions {
  margin-top:12px;
}

select, button {
  padding:10px;
  margin-top:6px;
  width:100%;
  font-size:14px;
}

button {
  background:#3fa55b;
  color:#fff;
  border:none;
  border-radius:999px;
  cursor:pointer;
}

button.close {
  background:#b33939;
}

@media print {
  body * { visibility:hidden; }
  .print-area, .print-area * { visibility:visible; }
  .print-area {
    position:absolute;
    left:0;
    top:0;
    width:80mm;
  }
}
</style>
</head>

<body>

<h1>ðŸ§¾ Billing Counter</h1>
<div id="orders"></div>

<script>
const KITCHEN_KEY = "kitchen_orders";
const CLOSED_KEY = "closed_bills";

loadOrders();
setInterval(loadOrders, 10000);

/* ================= LOAD ORDERS ================= */
function loadOrders() {
  const ordersDiv = document.getElementById("orders");
  const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
  ordersDiv.innerHTML = "";

  if (orders.length === 0) {
    ordersDiv.innerHTML = "<p>No open bills</p>";
    return;
  }

  orders.forEach(order => {

    let subtotal = 0;
    let itemsHTML = "";

    for (const k in order.items) {
      const i = order.items[k];
      const total = i.price * i.qty;
      subtotal += total;

      itemsHTML += `
        <div class="item">
          <span>${i.name} Ã— ${i.qty}</span>
          <span>â‚¹${total}</span>
        </div>
      `;
    }

    const cgst = +(subtotal * 0.025).toFixed(2);
    const sgst = +(subtotal * 0.025).toFixed(2);
    const grandTotal = +(subtotal + cgst + sgst).toFixed(2);

    ordersDiv.innerHTML += `
      <div class="order print-area">
        <h2>Table ${order.table}</h2>
        ${itemsHTML}

        <div class="summary">
          <div><span>Subtotal</span><span>â‚¹${subtotal}</span></div>
          <div><span>CGST (2.5%)</span><span>â‚¹${cgst}</span></div>
          <div><span>SGST (2.5%)</span><span>â‚¹${sgst}</span></div>
          <div><b>Total</b><b>â‚¹${grandTotal}</b></div>
        </div>

        <div class="actions">
          <select onchange="setPayment('${order.table}', this.value)">
            <option value="">Select Payment</option>
            <option value="Cash">Cash</option>
            <option value="UPI">UPI</option>
          </select>

          <button onclick="printBill(this)">ðŸ–¨ Print Bill</button>
          <button class="close" onclick="closeBill('${order.table}')">
            Close Bill
          </button>
        </div>
      </div>
    `;
  });
}

/* ================= SET PAYMENT ================= */
function setPayment(table, method) {
  const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
  const order = orders.find(o => o.table === table);
  if (order) {
    order.payment = method;
    localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));
  }
}

/* ================= CLOSE BILL ================= */
function closeBill(table) {

  let orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
  let closed = JSON.parse(localStorage.getItem(CLOSED_KEY)) || [];

  const index = orders.findIndex(o => o.table === table);

  if (index === -1) return;

  const order = orders[index];

  let subtotal = 0;
  for (const k in order.items) {
    subtotal += order.items[k].price * order.items[k].qty;
  }

  const cgst = +(subtotal * 0.025).toFixed(2);
  const sgst = +(subtotal * 0.025).toFixed(2);
  const total = +(subtotal + cgst + sgst).toFixed(2);

  closed.push({
    table: table,
    items: order.items,
    subtotal,
    cgst,
    sgst,
    total,
    payment: order.payment || "Cash",
    time: new Date().toISOString()
  });

  localStorage.setItem(CLOSED_KEY, JSON.stringify(closed));

  orders.splice(index, 1);
  localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));

  alert("Bill closed");
  loadOrders();
}

/* ================= PRINT ================= */
function printBill(btn) {
  const box = btn.closest(".order");
  document.querySelectorAll(".order").forEach(o => {
    if (o !== box) o.style.display = "none";
  });
  window.print();
  document.querySelectorAll(".order").forEach(o => o.style.display = "");
}
</script>

</body>
</html>
