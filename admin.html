<!DOCTYPE html>
<html>
<head>
<title>Kitchen & Billing</title>

<style>
body {
  font-family: Arial;
  background:#f2f2f2;
  padding:20px;
}

.order-box {
  background:#fff;
  padding:16px;
  margin-bottom:20px;
  border-radius:10px;
  border:2px solid #333;
  page-break-inside: avoid;
}

.table-title {
  font-size:18px;
  font-weight:bold;
  margin-bottom:8px;
}

.items {
  border-top:1px solid #ccc;
  border-bottom:1px solid #ccc;
  padding:10px 0;
}

.item-row {
  display:flex;
  justify-content:space-between;
  margin:6px 0;
}

.total {
  text-align:right;
  font-weight:bold;
  margin-top:10px;
  line-height:1.6;
}

.actions {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:12px;
}

select, button {
  padding:8px 12px;
  font-size:14px;
}

.print-btn {
  background:#7b4b2a;
  color:#fff;
  border:none;
  cursor:pointer;
}

.close-btn {
  background:#3fa55b;
  color:#fff;
  border:none;
  cursor:pointer;
}

/* ===== PRINT FIX ===== */
@media print {
  body * {
    visibility: hidden;
  }

  .print-area, .print-area * {
    visibility: visible;
  }

  .print-area {
    position: absolute;
    left: 0;
    top: 0;
    width: 80mm;     /* thermal printer safe */
    padding: 10px;
    font-size: 12px;
  }

  button, select {
    display: none;
  }
}
</style>
</head>

<body>

<h1>üçΩÔ∏è Kitchen & Billing</h1>

<div id="orders"></div>

<hr>

<!-- ‚úÖ SINGLE REPORT SECTION -->
<h2>üìä Reports</h2>
<button onclick="exportDailySummaryExcel()">üìÖ Day-wise Excel</button>
<button onclick="exportMonthlyExcel()">üìÜ Monthly Excel</button>
<button onclick="loadMonthly()">üìä Monthly Summary (Screen)</button>
<div id="report"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const KITCHEN_KEY = "kitchen_orders";
  const ordersDiv = document.getElementById("orders");

  loadOrders();

  /* ===== AUTO REFRESH EVERY 10 SECONDS ===== */
  setInterval(loadOrders, 10000);

  function loadOrders() {
    const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
    ordersDiv.innerHTML = "";

    const openOrders = orders.filter(o => o.status === "Open");

    if (openOrders.length === 0) {
      ordersDiv.innerHTML = "<p>No open orders</p>";
      return;
    }

    openOrders.forEach(order => {

      let itemsHTML = "";
      let subTotal = 0;

      for (const key in order.items) {
        const item = order.items[key];
        const lineTotal = item.price * item.qty;
        subTotal += lineTotal;

        itemsHTML += `
          <div class="item-row">
            <span>${item.name} √ó ${item.qty}</span>
            <span>‚Çπ${lineTotal.toFixed(2)}</span>
          </div>
        `;
      }

      const cgst = subTotal * 0.025;
      const sgst = subTotal * 0.025;
      const grandTotal = subTotal + cgst + sgst;

      ordersDiv.innerHTML += `
        <div class="order-box print-area">
          <div class="table-title">Table ${order.table}</div>

          <div class="items">
            ${itemsHTML}
            <div class="total">
              Subtotal: ‚Çπ${subTotal.toFixed(2)}<br>
              CGST (2.5%): ‚Çπ${cgst.toFixed(2)}<br>
              SGST (2.5%): ‚Çπ${sgst.toFixed(2)}<br>
              <strong>Grand Total: ‚Çπ${grandTotal.toFixed(2)}</strong>
            </div>
          </div>

          <div class="actions">
            <div>
              Payment:
              <select onchange="setPayment('${order.table}', this.value)">
                <option value="">Select</option>
                <option value="Cash" ${order.payment==="Cash"?"selected":""}>Cash</option>
                <option value="UPI" ${order.payment==="UPI"?"selected":""}>UPI</option>
              </select>
            </div>

            <div>
              <button class="print-btn" onclick="printThis(this)">Print Bill</button>
              <button class="close-btn" onclick="closeBill('${order.table}')">
                Close Bill
              </button>
            </div>
          </div>
        </div>
      `;
    });
  }

  /* ===== PAYMENT ===== */
  window.setPayment = function (table, method) {
    const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
    const order = orders.find(o => o.table === table && o.status === "Open");
    if (order) {
      order.payment = method;
      localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));
    }
  };

  /* ===== CLOSE BILL ===== */
  window.closeBill = function (table) {
    const orders = JSON.parse(localStorage.getItem(KITCHEN_KEY)) || [];
    const index = orders.findIndex(o => o.table === table && o.status === "Open");

    if (index === -1) return;

    if (!orders[index].payment) {
      alert("Please select payment method before closing bill");
      return;
    }

    orders.splice(index, 1);
    localStorage.setItem(KITCHEN_KEY, JSON.stringify(orders));
    loadOrders();
  };

  /* ===== PRINT ONLY THIS ORDER ===== */
  window.printThis = function (btn) {
    const box = btn.closest(".order-box");
    document.querySelectorAll(".order-box").forEach(b => {
      if (b !== box) b.style.display = "none";
    });

    window.print();

    document.querySelectorAll(".order-box").forEach(b => {
      b.style.display = "";
    });
  };

});
</script>

</body>
</html>
